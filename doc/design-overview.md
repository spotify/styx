# Styx design overview

## Architecture and dependencies

![Styx architecture](./styx-architecture.png)

## Conceptual overview of workflows

Three main Styx components are described in this section: **RunState**, **EventVisitor** and **OutputHandlers**.

A RunState is an object describing the current state of execution of a workflow instance. As such, a RunState relates to a specific state in the state graph (reported in the next section). The RunState object potentially carries more information regarding the execution flow of the workflow instance, for example the _execution id_ of the latest attempt or the current number of attempts.
According to the event received for a certain workflow instance, the associated RunState transitions into a new RunState (if allowed by the state machine rules).
The map of the RunState objects for all the active workflow instances in Styx is also a fundamental component of the service. Such map can always be restored at Styx's startup using the information from the persistent layer.

The whole set of events that trigger RunState transitions is defined in the EventVisitor class. These events can be generated by Styx itself or received from external systems. In the latter case, the received events are translated into Styx compliant events before being injected into the system.

When a RunState transition occurs, a set of OutputHandlers is executed accordingly. The OutputHandlers are used to execute all the operations related to a certain transition, for example starting a new Docker run or storing execution information in the persistent layer.

All the events and the related RunState transitions happens on a single thread. However, the OutputHandlers are executed on an executor service, so they could happen in parallel.


See [`RunState.java`](../styx-common/src/main/java/com/spotify/styx/state/RunState.java), [`EventVisitor.java`](../styx-common/src/main/java/com/spotify/styx/model/EventVisitor.java) and [`OutputHandlers`](../styx-scheduler-service/src/test/java/com/spotify/styx/state/handlers).

### Workflow state graph

Each workflow instance will be executed until completion or until the maximum number of retries is reached. This means that one or more actual docker runs will happen per workflow instance. How many depends on the exit codes of the runs:
- _**Exit code 0**_ is treated as a successful run and the associated workflow instance is removed from the active set;
- _**Exit code 20**_ is considered by Styx as a run that failed due to missing dependencies that are expected to be present in the following executions. The approach in this case is to schedule a retry after a fixed timeout;
- _**Other exit codes**_ are treated as generic execution errors. In this case Styx reruns the workflow instance after a timeout that increases with the number of attempts.

This whole process follows this state graph:

![Styx state machine](./state-graph.png)

#### State NEW

This is the entry state for a workflow instance. 

#### State PREPARE

This state looks up metadata about the workflow instance and stores it
within the state machine. Metadata is information such as docker image, 
source code repository, etc.

#### State SUBMITTING

This state submits a new pod to GKE and waits until GKE has accepted it. 

#### State SUBMITTED

GKE have received the request for starting a new pod. Styx is now waiting
for GKE to report back that the pod has started.

#### State RUNNING

The pod has started and the container is running. Styx is 
waiting for the workflow instance to finish.

#### State TERMINATED

The container within the pod is done and the pod has terminated.

#### State AWAITING_RETRY

Exit code from the pod was not 0 and Styx is waiting to schedule another
try.

#### State FAILED

Submission of job failed and Styx tries to determine if the job shall
be rescheduled for a retry or not.

#### State DONE

A workflow instance has succeed and is done.

#### State ERROR

A workflow instance has permanently failed. No more retries will be done.
